<div id=D__ID>
    <div class='container p-4' style='max-width:800px;margin-left:auto;margin-right:auto;background-color:rgb(250,250,234,1);border-radius:20px'>
        <form id=F__ID>
            <div id=S10__ID>
                <!-- participant part for all tsak forms -------------------->
                <div id="participant_div__ID" >
                    <div class="row px-4">
                        <div class="col-sm-12 col-lg-3">
                            <span class=label__ID>Participant ID</span><br>
                            <input type=text name="Participant_uid" class=form-control readonly />
                        </div>
                    </div>
                    <hr>
                </div>
                <div id=lab_result__ID >
                    <div class="form-group">
                        <div class="questiongroup ">
                            <fieldset class="">
                                <label><span class="">Status</span></label><br>
                                <label class="checkboxes">
                                    <input type="checkbox" name="lab_not_received">
                                    <span class="check_checkmark"></span>Sample not yet received by the University of Sydney</span>
                                </label><br>
                                <label class="checkboxes">
                                    <input type="checkbox" name="lab_received">
                                    <span class="check_checkmark"></span>Sample received by University of Sydney</span>
                                 </label><br>
                                <label class="checkboxes">
                                    <input type="checkbox" name="lab_can_analysis">
                                    <span class="check_checkmark"></span>Sample analysis (cannabinoid &amp; terpenoid) in progress</span>
                                 </label><br>
                                 <label class="checkboxes">
                                    <input type="checkbox" name="lab_cont_analysis">
                                    <span class="check_checkmark"></span>Sample analysis (contaminant) in progress</span>
                                 </label><br>
                                 <label class="checkboxes">
                                    <input type="checkbox" name="lab_result_pending">
                                    <span class="check_checkmark"></span>Sample analysis results pending</span>
                                 </label><br>
                                 <label class="checkboxes">
                                    <input type="checkbox" name="lab_result_available">
                                    <span class="check_checkmark"></span>Sample analysis results available</span>
                                 </label><br>
                            </fieldset>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="questiongroup ">
                            <fieldset class="">
                                <label style="width:100%"><span class="">Result</span>
                                    <textarea class="form-control" name="Result" ></textarea>
                                </label>
                            </fieldset>
                        </div>
                    </div>    
                </div>                    
                <div class="form-group">
                    <div class="questiongroup">
                        <fieldset class="pl-2">
                            <label><span class="">I would like a free and completely anonymous content analysis of my cannabis</span></label><br>
                            <label class="radiobuttons ">
                                <input type="radio" name="lab_analysis" value="1" required>
                                <span class="checkmark"></span>Yes</label>
                            <label class="radiobuttons ">
                                <input type="radio" name="lab_analysis" value="0">
                                <span class="checkmark"></span>No </label>
                        </fieldset>
                    </div>
                </div>
            </div>
            <button id=submit__ID type="submit" d=1 style="border-radius:2rem;background-color: #748A66;width:180px;height:60px;font-family: Arial, Helvetica, sans-serif" class="btn btn-success btn-lg">Submit</button>

<!--
            <div class="form-control">
                <u style='cursor:pointer' id=link_File_Name__ID></u>
                <br>
                <input type="file" name=File_Name style="margin-top:6px" /> <button type="button" id=x_File_Name__ID>Remove</button>
            </div>
-->
        </form>
    </div>
    VmInclude:__COMPONENT__/m/model.01.html
    <script>
        function F__ID(){



            //-------------------------------------
            VmInclude:'__COMPONENT__/f/form.01.js'



            //---------------------------------------------
            $vm.getB64Str=function(buffer) {
                var binary = '';
                var bytes = new Uint8Array(buffer);
                var len = bytes.byteLength;
                for (var i = 0; i < len; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return window.btoa(binary);
            }
            //---------------------------------------------
            m.set_file_link_s0=function(tag){
                $('#link_'+tag+'__ID').html("");
                $('#x_'+tag+'__ID').hide();
                var record=m.input.record;
                if(record==undefined) return;
                var filename=record.Data[tag];
                if(filename==undefined){
                    filename="";
                }
                else{
                    $('#x_'+tag+'__ID').show();
                }
                $('#link_'+tag+'__ID').html(filename);
                $('#link_'+tag+'__ID').off().on('click',function(){
                    if(record._id!==undefined && filename!=""){
                        var rid=record.UID;
                        var done=0;
                        var get_file_from_server=function(){
                            if(done==0){
                                $vm.request_S({api:m.api,cmd:"file",id:rid,table:m.Table,uid:record.UID, field:tag,filename:filename,options:m.options},function(res, textStatus, xhr){
                                    try{
                                        if(res=="404"){
                                            alert("No such file.");
                                            return;
                                        };
                                    }
                                    catch(e){}
                                    if('caches' in window){
                                        caches.open('VM').then(cache => {
                                            var aHeaders = new Headers();
                                            aHeaders.append('last-modifie',xhr.getResponseHeader('last-modified'));
                                            var rs=new Response(res, { "headers" :aHeaders} );
                                            cache.put(m.Table+"-"+rid+"-"+tag,rs);
                                            return;
                                        })
                                    }
                                    var link=document.createElement('a');
                                    var url = window.URL || window.webkitURL;
                                    link.href=url.createObjectURL(res);
                                    link.download=filename;
                                    link.click();
                                    //document.body.removeChild(link);
                                });
                            }
                        }
                        var get_file_from_cache=function(){
                            if('caches' in window){
                                caches.open('VM').then(
                                    cache => {
                                        cache.match(m.Table+"-"+rid+"-"+tag).then(response => {
                                            if(response){
                                                $vm.request_S({api:m.api,cmd:"file",id:rid,table:m.Table,uid:record.UID, field:tag,filename:filename,datetime:1,options:m.options},function(res){
                                                    var dtA=new Date(response.headers.get('last-modifie')).getTime();
                                                    var dtB=new Date(res.result).getTime();
                                                    dtA=dtA-dtA%1000;
                                                    dtB=dtB-dtB%1000;
                                                    if(dtA==dtB){
                                                        response.blob().then(function(myBlob) {
                                                            var link=document.createElement('a');
                                                            var url = window.URL || window.webkitURL;
                                                            link.href=url.createObjectURL(myBlob);
                                                            link.download=filename;
                                                            link.click();
                                                        });
                                                    }
                                                    else get_file_from_server();
                                                })
                                            }
                                            else{
                                                get_file_from_server();
                                            }
                                        })
                                    }
                                )
                            }
                        }
                        get_file_from_cache();
                    }
                    else alert("No file was found on server.")
                });
                $('#x_'+tag+'__ID').on('click',function(){
                    $('#link_'+tag+'__ID').html('');
                    $('#x_'+tag+'__ID').hide();
                    record.Data[tag]="";
                    $('#F__ID input[name='+tag+']').val('');
                })
                $('#F__ID input[name='+tag+']').on('change',function(){
                    if($(this).val()!='') $('#x_'+tag+'__ID').show();
                });
            }
            //-------------------------------

            $vm.request_S=function(req,callback,progress){
                var api_url=$vm.api_address;
                var token_name="vm_token";
                if(req.api!=undefined){
                    api_url=$vm.api_addresses[req.api];
                    token_name=req.api+" token";
                }
                
                $vm.sys_N++;
                var this_N=$vm.sys_N;
                $vm.sys_token="guest|where|when|scode";
                if($vm.debug_message===true){
                    console.log("%c"+req.cmd+'('+this_N+') TO ',"color:orange",req);
                }
                var dt1=new Date().getTime();
                $vm.ajax_server_error=0;
                //var token=sessionStorage.getItem("vm_token");
                var token=sessionStorage.getItem(token_name);
                if(token==undefined) token="";
                
                var param={
                    headers:{'Authorization':'Bearer ' + token},
                    type: "POST",
                    url: api_url,
                    contentType: "application/json",
                    charset:"utf-8",
                    dataType: "json",
                    error: function(jqXHR,error, errorThrown){ 
                        if(error && req.cmd=='file'){callback(404);}
                        if(jqXHR.status) {} 
                        else {}
                    },
                    data: JSON.stringify(req),
                    success: function(c,textStatus, request){
                        var dt2=new Date().getTime();
                        if($vm.debug_message===true){
                            if(c.status=='ok' || req.cmd=='file')  console.log("%c"+req.cmd+'('+this_N+') FROM'+" --- "+(dt2-dt1).toString()+"ms","color:lightgreen",c);
                            else                                   console.log("%c"+req.cmd+'('+this_N+') FROM'+" --- "+(dt2-dt1).toString()+"ms","color:red",c);
                        }
                        if($vm.ajax_server_error==1) return;
                        try{
                            if(callback!==undefined) callback(c,textStatus, request);
                        }catch(err){
                            alert(err.toString());
                        }
                    },
                    dataFilter: $vm.request_filter,
                }
                if(progress!=undefined){
                    param.xhr=function(){
                        var xhr = $.ajaxSettings.xhr() ;
                        xhr.upload.onprogress = function(evt){ progress(evt.loaded, evt.total); } ;
                        xhr.upload.onload = function(){ } ;
                        return xhr ;
                    }
                }
                if(req.cmd=="export" || req.cmd=="export2"){
                    param.xhr=function(){
                        var i=1;
                        var xhr = new window.XMLHttpRequest();
                        xhr.addEventListener("progress", function(evt){
                            var N=-1,end="";
                            var len=xhr.responseText.length;
                            if(len>=5 && N==-1)  N=parseInt(xhr.responseText.substring(0,5));
                            if(len>=14) end=xhr.responseText.substring(len-9,len);
                            if(end=='__E_N_D__') i=-1;
                            callback(N,i,xhr.responseText);
                            i++;
                        }, false);
                        return xhr;
                    }
                }
                else if( req.cmd=="file" && req.datetime==undefined ){
                    delete param.dataType;
                    param.xhrFields={responseType: 'blob'};
                }
                $.ajax(param)
            };
            //-----------------------------------------------------------------
            m.storage_type='s0';




            VmInclude:__CURRENT_PATH__/shared-form.js
            //-------------------------------------
            var load2=m.load;
            m.load=function(){
                load2();
                m.set_file_link_s0("File_Name");
                
                $('#title__ID').text($vm.module_list[$vm.vm['__ID'].name].task_name);
                console.log(JSON.stringify(m.input.participant_record))
                console.log(JSON.stringify(m.input.lab))
                if(m.input!=undefined) $vm.deserialize(m.input.lab,'#F__ID');
                if(m.input.lab.Data.lab_analysis=="1"){
                    $('#submit__ID').hide();
                    $('#lab_result__ID').show();
                }
                $('#Participant__ID').val(m.input.participant_record.UID);
                $('#D__ID input[name=Participant_uid]').val(m.input.participant_record.UID);
                $('#Participant__ID').attr('readonly', true);
                $('#Participant__ID').addClass('input-disabled');
            }
            //-------------------------------------
        }
    </script>
    <style>
        #D__ID .mt-95 {
        max-width:600px;
    }
      VmInclude:__CURRENT_PATH__/wappsystem-form.css
    </style>
  </div>